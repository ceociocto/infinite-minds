name: Auto Issue Processing

on:
  issues:
    types: [opened]

jobs:
  analyze-issue:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Analyze Issue
        id: analyze
        uses: anomalyco/opencode/github@latest
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        with:
          model: zai-coding-plan/glm-4.7
          prompt: |
            Analyze this GitHub issue and provide a detailed plan:
            Issue Title: ${{ github.event.issue.title }}
            Issue Body: ${{ github.event.issue.body }}
            
            Please analyze:
            1. What is the issue about?
            2. What files might need to be changed?
            3. What is the proposed solution?
            4. Any potential risks or considerations?
            
            Reply with a structured analysis as a comment on this issue.

      - name: Post Analysis Comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## üîç Issue Analysis\n\n' + '${{ steps.analyze.outputs.result }}' + '\n\n---\n*This analysis was automatically generated by AI*'
            })

  implement-fix:
    needs: analyze-issue
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.create-pr.outputs.result }}
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Create Branch
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          BRANCH_NAME="auto-fix-issue-${{ github.event.issue.number }}-$(date +%s)"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Implement Fix
        id: implement
        uses: anomalyco/opencode/github@latest
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        with:
          model: zai-coding-plan/glm-4.7
          prompt: |
            Implement the fix for this GitHub issue:
            Issue Title: ${{ github.event.issue.title }}
            Issue Body: ${{ github.event.issue.body }}
            
            Please:
            1. Make the necessary code changes to fix the issue
            2. Follow the existing code style and patterns
            3. Ensure the changes are minimal and focused
            4. Do not break existing functionality
            
            Make changes directly to the codebase.

      - name: Commit Changes
        run: |
          git add -A
          git commit -m "fix: auto-fix for issue #${{ github.event.issue.number }}
          
          ${{ github.event.issue.title }}
          
          Changes made by AI agent"
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ Auto-fix: ${context.payload.issue.title}`,
              body: `This PR automatically fixes issue #${context.payload.issue.number}
            
            ## Changes
            AI agent has analyzed and implemented a fix for the reported issue.
            
            ## Related Issue
            Closes #${context.payload.issue.number}
            
            ---
            *This PR was automatically generated by the AI agent*`,
              head: process.env.BRANCH_NAME,
              base: context.payload.repository.default_branch
            });
            
            // Link PR to issue
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üõ†Ô∏è Implementation Started\n\nI've created a pull request #${pullRequest.number} with the fix.\n\nPlease review the changes and let me know if any adjustments are needed.`
            });
            
            return pullRequest.number;

  auto-merge:
    needs: implement-fix
    runs-on: ubuntu-latest
    if: success()
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Wait for PR checks
        run: sleep 30

      - name: Auto-merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.implement-fix.outputs.pr_number }};
            
            try {
              // Check if PR is mergeable
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              if (pr.mergeable && pr.mergeable_state === 'clean') {
                // Merge the PR
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'squash',
                  commit_title: `fix: auto-fix for issue #${context.payload.issue.number}`,
                  commit_message: `Automatically merged by AI agent\n\nCloses #${context.payload.issue.number}`
                });
                
                // Comment on the issue
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## ‚úÖ Fix Merged\n\nThe fix has been successfully merged into the main branch!\n\n- PR #${prNumber} has been merged\n- Changes are now live\n\nThank you for reporting this issue.`
                });
                
                // Close the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  state: 'closed'
                });
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## ‚è≥ Awaiting Review\n\nThe PR #${prNumber} has been created but requires manual review before merging.\n\nPlease review the changes and approve if everything looks good.`
                });
              }
            } catch (error) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ‚ö†Ô∏è Merge Failed\n\nAutomatic merge failed. Manual intervention required.\n\nError: ${error.message}`
              });
            }
